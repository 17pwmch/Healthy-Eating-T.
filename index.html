<!doctype html>
<html lang="th" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AR Healthy Eating</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-landmarks-detection"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { margin: 0; padding: 0; overflow: hidden; }
    @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap');
    * { font-family: 'Fredoka', 'Comic Sans MS', cursive; }
    
    #videoBackground {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      transform: scaleX(-1);
      z-index: 1;
    }
    
    .game-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 2;
    }
    
    @keyframes fall {
      from { transform: translateY(-100px); }
      to { transform: translateY(calc(100vh + 100px)); }
    }
    
    .falling {
      animation: fall linear forwards;
      position: absolute;
      font-size: 64px;
      z-index: 20;
      filter: drop-shadow(3px 3px 6px rgba(0,0,0,0.7));
    }
    
    .mouth-indicator {
      position: absolute;
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: 5px solid #6b7280;
      transition: all 0.1s;
      z-index: 30;
      background: rgba(107, 114, 128, 0.1);
    }
    
    .mouth-open {
      border-color: #10b981 !important;
      border-width: 6px !important;
      box-shadow: 0 0 40px rgba(16, 185, 129, 0.8);
      background: rgba(16, 185, 129, 0.2) !important;
    }
    
    @keyframes catch-effect {
      0% { transform: scale(1) rotate(0); opacity: 1; }
      100% { transform: scale(0) rotate(360deg); opacity: 0; }
    }
    
    .catch-effect { animation: catch-effect 0.3s ease-out; }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    .pulse { animation: pulse 1s ease-in-out infinite; }
  </style>
</head>
<body>
  <div id="app"></div>
  <script>
    let detector, videoStream;
    let state = {
      screen: 'menu', level: 1, score: 0, healthyCount: 0, junkCount: 0, lives: 3,
      mouthOpen: false, gameActive: false, fallingItems: [], mouthX: 0, mouthY: 0,
      videoWidth: 640, videoHeight: 480, faceDetected: false
    };

    const levels = [
      { name: "Breakfast", duration: 30, speed: 4 },
      { name: "Lunch", duration: 40, speed: 3.5 },
      { name: "Dinner", duration: 50, speed: 3 }
    ];

    const healthyFoods = ['üçé','ü•ó','ü•¶','ü•ï','üçä','üçá','ü•ë','üçì'];
    const junkFoods = ['üçî','üçï','üçü','üç©','üç∞','üå≠'];
    const bombs = ['üí£'];

    async function setupCamera() {
      try {
        videoStream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'user', width: 1280, height: 720 } 
        });
        const video = document.getElementById('videoBackground');
        video.srcObject = videoStream;
        await video.play();
        
        state.videoWidth = video.videoWidth || 640;
        state.videoHeight = video.videoHeight || 480;
        
        const model = faceLandmarksDetection.SupportedModels.MediaPipeFaceMesh;
        detector = await faceLandmarksDetection.createDetector(model, {
          runtime: 'tfjs', refineLandmarks: true, maxFaces: 1
        });
        
        detectMouth();
      } catch (e) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏•‡πâ‡∏≠‡∏á / Please allow camera');
      }
    }

    async function detectMouth() {
      if (!state.gameActive || !detector) return;
      
      const video = document.getElementById('videoBackground');
      if (!video || video.readyState < 2) {
        requestAnimationFrame(detectMouth);
        return;
      }

      try {
        const faces = await detector.estimateFaces(video);
        if (faces.length > 0) {
          state.faceDetected = true;
          const kp = faces[0].keypoints;
          const upperLip = kp[13], lowerLip = kp[14];
          
          const mouthCenterX = (upperLip.x + lowerLip.x) / 2;
          const mouthCenterY = (upperLip.y + lowerLip.y) / 2;
          
          const videoRect = video.getBoundingClientRect();
          const scaleX = videoRect.width / state.videoWidth;
          const scaleY = videoRect.height / state.videoHeight;
          
          state.mouthX = videoRect.width - (mouthCenterX * scaleX);
          state.mouthY = mouthCenterY * scaleY;
          state.mouthOpen = Math.abs(lowerLip.y - upperLip.y) > 10;
          
          updateMouthIndicator();
          checkFoodCatch();
        } else {
          state.faceDetected = false;
        }
      } catch (e) {}

      if (state.gameActive) requestAnimationFrame(detectMouth);
    }

    function updateMouthIndicator() {
      const ind = document.getElementById('mouthIndicator');
      if (!ind) return;
      ind.style.left = state.mouthX + 'px';
      ind.style.top = state.mouthY + 'px';
      ind.style.transform = 'translate(-50%, -50%)';
      ind.className = 'mouth-indicator' + (state.mouthOpen ? ' mouth-open' : '');
    }

    function checkFoodCatch() {
      if (!state.mouthOpen) return;
      
      state.fallingItems.forEach(item => {
        if (item.caught) return;
        const el = document.getElementById('food-' + item.id);
        if (!el) return;
        
        const rect = el.getBoundingClientRect();
        const dx = rect.left + rect.width/2 - state.mouthX;
        const dy = rect.top + rect.height/2 - state.mouthY;
        const dist = Math.sqrt(dx*dx + dy*dy);
        
        if (dist < 90) catchFood(item, el);
      });
    }

    function catchFood(item, el) {
      item.caught = true;
      el.classList.add('catch-effect');
      setTimeout(() => el.style.display = 'none', 100);
      
      if (item.type === 'bomb') {
        state.lives--;
        if (state.lives <= 0) endGame();
      } else if (item.type === 'healthy') {
        state.score += 10;
        state.healthyCount++;
      } else {
        state.score += 5;
        state.junkCount++;
      }
      updateUI();
    }

    function startGame(level) {
      state = { ...state, level, score: 0, healthyCount: 0, junkCount: 0, lives: 3, 
                gameActive: true, fallingItems: [], screen: 'game' };
      render();
      setupCamera();
      spawnFood();
      startTimer();
    }

    function spawnFood() {
      if (!state.gameActive) return;
      
      const lvl = levels[state.level - 1];
      const rand = Math.random();
      let food = rand < 0.5 ? healthyFoods[~~(Math.random()*healthyFoods.length)] :
                 rand < 0.85 ? junkFoods[~~(Math.random()*junkFoods.length)] : bombs[0];
      
      const type = junkFoods.includes(food) ? 'junk' : bombs.includes(food) ? 'bomb' : 'healthy';
      const item = { id: Date.now() + Math.random(), emoji: food, type, 
                     x: Math.random()*80 + 10, caught: false };
      state.fallingItems.push(item);
      
      const overlay = document.getElementById('gameOverlay');
      const foodEl = document.createElement('div');
      foodEl.id = 'food-' + item.id;
      foodEl.className = 'falling';
      foodEl.style.left = item.x + '%';
      foodEl.style.animationDuration = lvl.speed + 's';
      foodEl.textContent = item.emoji;
      overlay.appendChild(foodEl);
      
      setTimeout(() => {
        foodEl.remove();
        state.fallingItems = state.fallingItems.filter(i => i.id !== item.id);
      }, lvl.speed * 1000);
      
      setTimeout(() => spawnFood(), 1200 / Math.sqrt(lvl.speed));
    }

    function startTimer() {
      const lvl = levels[state.level - 1];
      let time = lvl.duration;
      const timer = setInterval(() => {
        if (!state.gameActive) return clearInterval(timer);
        time--;
        const el = document.getElementById('timer');
        if (el) el.textContent = '‚è±Ô∏è ' + time + 's';
        if (time <= 0) { clearInterval(timer); endGame(); }
      }, 1000);
    }

    function endGame() {
      state.gameActive = false;
      if (videoStream) videoStream.getTracks().forEach(t => t.stop());
      state.screen = 'result';
      render();
    }

    function updateUI() {
      const s = document.getElementById('score');
      const l = document.getElementById('lives');
      if (s) s.textContent = 'üèÜ ' + state.score;
      if (l) l.textContent = '‚ù§Ô∏è ' + state.lives;
    }

    function render() {
      const app = document.getElementById('app');
      if (state.screen === 'menu') {
        app.innerHTML = `
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                      width: 100vw; height: 100vh; display: flex; align-items: center; 
                      justify-content: center; padding: 2rem;">
            <div style="background: white; border-radius: 24px; padding: 3rem; 
                        max-width: 600px; text-align: center;">
              <h1 style="font-size: 3rem; font-weight: bold; margin-bottom: 1rem;" class="pulse">
                üçé AR Healthy Eating ü•ó
              </h1>
              <p style="font-size: 1.2rem; margin-bottom: 2rem;">
                ‡πÉ‡∏ä‡πâ‡∏õ‡∏≤‡∏Å‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏à‡∏±‡∏ö‡∏≠‡∏≤‡∏´‡∏≤‡∏£!<br>Use your real mouth to catch food!
              </p>
              <div style="background: rgba(16,185,129,0.1); border: 2px solid #10b981; 
                          border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                <p style="font-size: 1.3rem; font-weight: bold; margin-bottom: 0.5rem;">
                  üí° ‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏•‡πà‡∏ô
                </p>
                <p>üìπ ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á</p>
                <p>üòÆ ‡∏≠‡πâ‡∏≤‡∏õ‡∏≤‡∏Å‡∏à‡∏±‡∏ö‡∏≠‡∏≤‡∏´‡∏≤‡∏£</p>
                <p>üéØ ‡∏ß‡∏á‡∏Å‡∏•‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß = ‡∏û‡∏£‡πâ‡∏≠‡∏°!</p>
              </div>
              ${levels.map((l, i) => `
                <button onclick="startGame(${i+1})" 
                  style="width: 100%; padding: 1rem 2rem; margin: 0.5rem 0; 
                         font-size: 1.2rem; font-weight: bold; border-radius: 12px; 
                         border: none; color: white; cursor: pointer;
                         background: ${i === 0 ? '#10b981' : '#8b5cf6'};">
                  Level ${i+1}: ${l.name} (${l.duration}s)
                </button>
              `).join('')}
            </div>
          </div>
        `;
      } else if (state.screen === 'game') {
        app.innerHTML = `
          <video id="videoBackground" autoplay muted playsinline></video>
          <div id="gameOverlay" class="game-overlay">
            <div style="position: fixed; top: 1rem; left: 1rem; z-index: 50; display: flex; gap: 1rem;">
              <div id="score" style="background: rgba(255,255,255,0.9); padding: 0.75rem 1.5rem; 
                                     border-radius: 12px; font-size: 1.5rem; font-weight: bold;">üèÜ 0</div>
              <div id="lives" style="background: rgba(255,255,255,0.9); padding: 0.75rem 1.5rem; 
                                     border-radius: 12px; font-size: 1.5rem; font-weight: bold;">‚ù§Ô∏è 3</div>
              <div id="timer" style="background: rgba(255,255,255,0.9); padding: 0.75rem 1.5rem; 
                                     border-radius: 12px; font-size: 1.5rem; font-weight: bold;">
                ‚è±Ô∏è ${levels[state.level-1].duration}s
              </div>
            </div>
            <div id="mouthIndicator" class="mouth-indicator"></div>
            <div style="position: fixed; bottom: 1rem; left: 50%; transform: translateX(-50%); 
                        background: rgba(0,0,0,0.8); color: white; padding: 1rem 2rem; 
                        border-radius: 12px; font-size: 1.2rem; font-weight: bold; z-index: 50;">
              üòÆ ‡∏≠‡πâ‡∏≤‡∏õ‡∏≤‡∏Å‡∏£‡∏±‡∏ö‡∏ú‡∏•‡πÑ‡∏°‡πâ!
            </div>
          </div>
        `;
      } else {
        const ratio = state.healthyCount / (state.healthyCount + state.junkCount || 1);
        const emoji = ratio > 0.7 ? 'üí™üòä' : ratio > 0.4 ? 'üòê' : 'üò∞üçî';
        const msg = ratio > 0.7 ? '‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏î‡∏µ‡∏°‡∏≤‡∏Å!' : ratio > 0.4 ? '‡∏û‡∏≠‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ' : '‡∏Ñ‡∏ß‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û';
        
        app.innerHTML = `
          <div style="background: linear-gradient(135deg, #667eea, #764ba2); 
                      width: 100vw; height: 100vh; display: flex; align-items: center; 
                      justify-content: center; padding: 2rem;">
            <div style="background: white; border-radius: 24px; padding: 3rem; 
                        max-width: 600px; text-align: center;">
              <div style="font-size: 6rem; margin-bottom: 1rem;" class="pulse">${emoji}</div>
              <h2 style="font-size: 3rem; font-weight: bold; margin-bottom: 1rem;">‡πÄ‡∏Å‡∏°‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß!</h2>
              <h3 style="font-size: 2rem; color: #10b981; margin-bottom: 2rem;">${msg}</h3>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 2rem;">
                <div style="background: rgba(102,126,234,0.2); padding: 1.5rem; border-radius: 12px;">
                  <div style="font-size: 3rem;">üèÜ</div>
                  <div style="font-size: 2rem; font-weight: bold;">${state.score}</div>
                  <div>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
                </div>
                <div style="background: rgba(102,126,234,0.2); padding: 1.5rem; border-radius: 12px;">
                  <div style="font-size: 3rem;">üçé</div>
                  <div style="font-size: 2rem; font-weight: bold;">${state.healthyCount}</div>
                  <div>‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏î‡∏µ</div>
                </div>
                <div style="background: rgba(102,126,234,0.2); padding: 1.5rem; border-radius: 12px;">
                  <div style="font-size: 3rem;">üçî</div>
                  <div style="font-size: 2rem; font-weight: bold;">${state.junkCount}</div>
                  <div>‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Ç‡∏¢‡∏∞</div>
                </div>
                <div style="background: rgba(102,126,234,0.2); padding: 1.5rem; border-radius: 12px;">
                  <div style="font-size: 3rem;">üìä</div>
                  <div style="font-size: 2rem; font-weight: bold;">${Math.round(ratio*100)}%</div>
                  <div>‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏î‡∏µ</div>
                </div>
              </div>
              <button onclick="state.screen='menu'; render();" 
                style="width: 100%; padding: 1rem 2rem; font-size: 1.5rem; font-weight: bold; 
                       background: #10b981; color: white; border: none; border-radius: 12px; 
                       cursor: pointer;">
                üè† ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π
              </button>
            </div>
          </div>
        `;
      }
    }

    render();
  </script>
</body>
</html>
