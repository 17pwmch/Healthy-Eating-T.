<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>AR Healthy Eating</title>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.20.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-landmarks-detection@0.0.3/dist/face-landmarks-detection.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { margin:0; overflow:hidden; }
    #videoBackground {
      position: fixed; inset:0;
      width:100vw; height:100vh;
      object-fit:cover;
      transform: scaleX(-1);
      z-index:1;
    }
    .game-overlay { position:fixed; inset:0; z-index:2; pointer-events:none; }
    .falling {
      position:absolute;
      font-size:48px;
      animation: fall linear forwards;
    }
    @keyframes fall {
      from { transform: translateY(-100px); }
      to { transform: translateY(110vh); }
    }
    .mouth-indicator {
      position:fixed;
      width:120px; height:120px;
      border-radius:50%;
      border:5px solid #ef4444;
      background:rgba(239,68,68,.25);
      display:flex; align-items:center; justify-content:center;
      font-size:2.5rem;
      transform:translate(-50%,-50%);
      z-index:30;
    }
    .mouth-open {
      border-color:#10b981;
      box-shadow:0 0 30px #10b981;
      background:rgba(16,185,129,.35);
      transform:translate(-50%,-50%) scale(1.15);
    }
  </style>
</head>

<body>
<div id="app"></div>

<script>
let model, videoStream;

let state = {
  screen:'menu',
  gameActive:false,
  level:1,
  score:0,
  lives:3,
  fallingItems:[],
  mouthX:window.innerWidth/2,
  mouthY:window.innerHeight/2,
  mouthOpen:false,
  mouthHistory:[],
  lastCatchTime:0,
  videoWidth:640,
  videoHeight:480,
  modelLoaded:false
};

const healthyFoods = ['üçé','üçä','üçá','ü•¶','ü•ï','üçì'];
const junkFoods = ['üçî','üçï','üçü'];
const bombs = ['üí£'];

function render(){
  const app = document.getElementById('app');
  if(state.screen==='menu'){
    app.innerHTML = `
      <div style="height:100vh;display:flex;align-items:center;justify-content:center;">
        <button onclick="startGame()" style="font-size:2rem;">‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</button>
      </div>`;
  } else {
    app.innerHTML = `
      <video id="videoBackground" autoplay playsinline></video>
      <div class="game-overlay" id="gameOverlay"></div>
      <div id="mouthIndicator" class="mouth-indicator">üòê</div>`;
  }
}

async function startGame(){
  state.screen='game';
  state.gameActive=true;
  render();
  await setupCamera();
  spawnFood();
  detectMouth();
}

async function setupCamera(){
  videoStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}});
  const video = document.getElementById('videoBackground');
  video.srcObject = videoStream;
  await video.play();
  state.videoWidth = video.videoWidth;
  state.videoHeight = video.videoHeight;

  model = await faceLandmarksDetection.load(
    faceLandmarksDetection.SupportedPackages.mediapipeFacemesh,
    {maxFaces:1}
  );
  state.modelLoaded = true;
}

async function detectMouth(){
  if(!state.gameActive) return;

  const video = document.getElementById('videoBackground');
  const preds = await model.estimateFaces({input:video});

  if(preds.length){
    const m = preds[0].scaledMesh;
    const upper = m[13];
    const lower = m[14];
    const left = m[61];
    const right = m[291];

    const height = Math.abs(lower[1]-upper[1]);
    const width = Math.abs(right[0]-left[0]);

    state.mouthHistory.push(height);
    if(state.mouthHistory.length>5) state.mouthHistory.shift();
    const avg = state.mouthHistory.reduce((a,b)=>a+b,0)/state.mouthHistory.length;

    const threshold = Math.max(width*0.12,12);
    state.mouthOpen = avg > threshold;

    const rect = video.getBoundingClientRect();
    const sx = rect.width/state.videoWidth;
    const sy = rect.height/state.videoHeight;

    state.mouthX = rect.left + (rect.width - ((left[0]+right[0])/2)*sx);
    state.mouthY = rect.top + ((upper[1]+lower[1])/2)*sy;

    updateMouth();
    checkCatch();
  }

  setTimeout(detectMouth,100);
}

function updateMouth(){
  const el = document.getElementById('mouthIndicator');
  el.style.left = state.mouthX+'px';
  el.style.top = state.mouthY+'px';
  el.className = 'mouth-indicator'+(state.mouthOpen?' mouth-open':'');
  el.textContent = state.mouthOpen?'üòÆ':'üòê';
}

function spawnFood(){
  if(!state.gameActive) return;
  const emoji = Math.random()<0.7
    ? healthyFoods[Math.floor(Math.random()*healthyFoods.length)]
    : junkFoods[Math.floor(Math.random()*junkFoods.length)];

  const id = Date.now();
  const el = document.createElement('div');
  el.id='food-'+id;
  el.className='falling';
  el.textContent=emoji;
  el.style.left=Math.random()*80+10+'%';
  el.style.animationDuration='5s';

  document.getElementById('gameOverlay').appendChild(el);
  state.fallingItems.push({id,el});

  setTimeout(()=>spawnFood(),1800);
}

function checkCatch(){
  if(!state.mouthOpen) return;
  const now = Date.now();
  if(now-state.lastCatchTime<400) return;

  state.fallingItems.forEach(item=>{
    const r = item.el.getBoundingClientRect();
    const dx = r.left+r.width/2 - state.mouthX;
    const dy = r.top+r.height/2 - state.mouthY;
    if(Math.hypot(dx,dy)<130){
      item.el.remove();
      state.lastCatchTime = now;
    }
  });
}

render();
</script>
</body>
</html>
